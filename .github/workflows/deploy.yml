name: Deploy Stored Procedures (Liquibase) - Dev

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Install Java (required for Liquibase)
      - name: Install Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'  # Java 17 for better compatibility with 4.33.0

      # 3. Install SQL Server JDBC Driver
      - name: Download SQL Server JDBC Driver
        run: |
          mkdir -p $HOME/jdbc-drivers
          cd $HOME/jdbc-drivers
          wget https://repo1.maven.org/maven2/com/microsoft/sqlserver/mssql-jdbc/12.4.2.jre11/mssql-jdbc-12.4.2.jre11.jar
          echo "JDBC_CLASSPATH=$HOME/jdbc-drivers/mssql-jdbc-12.4.2.jre11.jar" >> $GITHUB_ENV

      # 4. Install Liquibase 4.33.0 (Fixed approach)
      - name: Install Liquibase 4.33.0
        run: |
          VERSION=4.33.0
          echo "Installing Liquibase version $VERSION"
          
          # Download and extract Liquibase 4.33.0
          wget -q https://github.com/liquibase/liquibase/releases/download/v${VERSION}/liquibase-${VERSION}.tar.gz
          mkdir -p $HOME/liquibase
          tar -xzf liquibase-${VERSION}.tar.gz -C $HOME/liquibase
          
          # Add to PATH
          echo "$HOME/liquibase" >> $GITHUB_PATH
          
          # Make executable
          chmod +x $HOME/liquibase/liquibase
          
          # Copy JDBC driver to Liquibase lib directory
          cp $HOME/jdbc-drivers/mssql-jdbc-12.4.2.jre11.jar $HOME/liquibase/lib/

      # 5. Verify installations
      - name: Verify Liquibase 4.33.0 installation
        run: |
          echo "=== PATH ==="
          echo $PATH
          echo ""
          echo "=== Java version ==="
          java -version
          echo ""
          echo "=== Liquibase installation ==="
          ls -la $HOME/liquibase/
          echo ""
          echo "=== Liquibase version ==="
          $HOME/liquibase/liquibase --version
          echo ""
          echo "=== JDBC Driver in lib ==="
          ls -la $HOME/liquibase/lib/ | grep mssql

      # 6. Validate changelog file
      - name: Validate changelog file
        run: |
          echo "=== Checking changelog file ==="
          if [ -f "liquibase/dbchangelog.xml" ]; then
            echo "✅ Changelog file exists"
            echo "File size: $(wc -c < liquibase/dbchangelog.xml) bytes"
            echo "First 10 lines:"
            head -10 liquibase/dbchangelog.xml
          else
            echo "❌ ERROR: Changelog file not found!"
            echo "Looking for XML files in project:"
            find . -name "*.xml" -type f
            exit 1
          fi

      # 7. Run Liquibase update with 4.33.0
      - name: Deploy stored procedures via Liquibase 4.33.0
        env:
          LB_URL: "jdbc:sqlserver://localhost;databaseName=MyTestDB;encrypt=false"
          LB_USERNAME: "YashGoyal"
          LB_PASSWORD: "Yash@123"
        run: |
          liquibase \
          --url="$LB_URL" \
          --username="$LB_USERNAME" \
          --password="$LB_PASSWORD" \
          --driver=com.microsoft.sqlserver.jdbc.SQLServerDriver \
          --changelog-file=liquibase/dbchangelog.xml \  # Changed from changeLogFile
          --hub-mode=off \                              # Changed from liquibase.hub.mode
          update
